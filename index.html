<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gram Shakti | Admin Hierarchy</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Hind', sans-serif; background: #f8fafc; }
        .admin-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #ea580c; shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-red { background: #ef4444; color: white; padding: 5px 10px; border-radius: 6px; font-size: 12px; }
        .btn-green { background: #22c55e; color: white; padding: 10px; border-radius: 8px; width: 100%; font-weight: bold; }
        .state-btn { background: linear-gradient(135deg, #1e293b, #334155); color: white; padding: 15px; border-radius: 12px; text-align: center; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body class="max-w-md mx-auto min-h-screen bg-white">

    <header class="flex items-center justify-between px-6 py-5 border-b bg-white sticky top-0 z-50">
        <div class="flex items-center gap-3">
            <div id="adminLogo" class="bg-orange-600 text-white w-10 h-10 flex items-center justify-center rounded-xl text-xl font-bold cursor-pointer select-none shadow-lg shadow-orange-200">G</div>
            <div>
                <h1 class="font-bold text-lg text-gray-800">Gram Shakti</h1>
                <p id="adminStatusText" class="text-[10px] text-gray-400 font-bold uppercase">Admin Panel Locked</p>
            </div>
        </div>
    </header>

    <div id="app" class="p-6"></div>

<script>
/* Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyCuvev3-jwZwQu0_fHYyv2E2ovLny4LhRQ",
  authDomain: "gram-shakti-b135a.firebaseapp.com",
  projectId: "gram-shakti-b135a",
  storageBucket: "gram-shakti-b135a.firebasestorage.app",
  messagingSenderId: "340909973482",
  appId: "1:340909973482:web:c562cb3dd591b78de21c93",
  databaseURL: "https://gram-shakti-b135a-default-rtdb.firebaseio.com"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let selectedPath = {};
let currentRole = "USER"; // ROLES: MAIN_ADMIN, STATE_ADMIN, DIST_ADMIN, USER

// --- Secret Admin Access ---
let pressTimer;
document.getElementById("adminLogo").addEventListener('mousedown', () => {
    pressTimer = window.setTimeout(() => {
        let pass = prompt("Enter Secret Key:");
        if(pass === "main786") { 
            currentRole = "MAIN_ADMIN";
            document.getElementById("adminStatusText").innerText = "Main Admin Mode";
            loadStatePanel();
        }
    }, 2000); 
});
document.getElementById("adminLogo").addEventListener('mouseup', () => clearTimeout(pressTimer));

// 1. राज्य लेवल का पैनल (Main Admin के लिए)
function loadStatePanel(){
    document.getElementById("app").innerHTML = `
    <h2 class="text-xl font-black mb-4 text-gray-800">Control State Admins</h2>
    <div class="grid gap-3">
        <div class="state-btn" onclick="manageState('Uttar Pradesh')">Uttar Pradesh</div>
        <div class="state-btn" onclick="manageState('Bihar')">Bihar</div>
    </div>`;
}

// 2. राज्य के अंदर जिला एडमिन को मैनेज करना
function manageState(stateName){
    selectedPath.state = stateName;
    document.getElementById("app").innerHTML = `
    <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-orange-600">${stateName} Panel</h3>
        <button onclick="loadStatePanel()" class="text-xs underline text-gray-500">Back</button>
    </div>
    
    <div class="admin-card">
        <p class="text-xs font-bold text-gray-400 mb-2 uppercase">Appoint State Head</p>
        <div id="stateAdminInfo">Checking...</div>
    </div>

    <h4 class="font-bold text-sm mb-3">Districts in ${stateName}</h4>
    <div id="distList" class="space-y-2">
        <input id="newDist" class="border p-2 w-full rounded" placeholder="Add District Name">
        <button onclick="goToDistrict()" class="btn-green">Manage District</button>
    </div>`;

    // राज्य के मुखिया को लोड करें
    db.ref("stateAdmins/" + stateName).on("value", snap => {
        let data = snap.val();
        let infoDiv = document.getElementById("stateAdminInfo");
        if(data) {
            infoDiv.innerHTML = `<b>Name:</b> ${data.name} <br> <button onclick="removeStateAdmin('${stateName}')" class="btn-red mt-2">Dismiss Admin</button>`;
        } else {
            infoDiv.innerHTML = `<input id="stName" class="border p-1 w-full text-sm mb-2" placeholder="Admin Name">
                                 <button onclick="saveStateAdmin('${stateName}')" class="text-xs bg-black text-white px-3 py-1 rounded">Appoint</button>`;
        }
    });
}

// 3. जिला लेवल का पैनल (State Admin या Main Admin के लिए)
function goToDistrict(){
    let dist = document.getElementById("newDist").value;
    if(!dist) return;
    selectedPath.district = dist;
    
    document.getElementById("app").innerHTML = `
    <h3 class="font-bold text-blue-600 mb-4">${selectedPath.district} Control</h3>
    
    <div class="admin-card border-l-blue-600">
        <p class="text-xs font-bold text-gray-400 mb-2 uppercase">District Admin</p>
        <div id="distAdminInfo">Checking...</div>
    </div>

    <div class="admin-card border-l-green-600">
        <p class="text-xs font-bold text-gray-400 mb-2 uppercase">Workers List</p>
        <div id="workersList" class="text-xs space-y-3">Loading Workers...</div>
    </div>
    <button onclick="manageState('${selectedPath.state}')" class="w-full text-gray-400 text-sm mt-4">Back to State</button>`;

    // जिले के मुखिया को लोड करें
    db.ref("distAdmins/" + selectedPath.district).on("value", snap => {
        let data = snap.val();
        let dInfo = document.getElementById("distAdminInfo");
        if(data) {
            dInfo.innerHTML = `<b>Admin:</b> ${data.name} <br> <button onclick="removeDistAdmin('${selectedPath.district}')" class="btn-red mt-2">Remove</button>`;
        } else {
            dInfo.innerHTML = `<input id="dsName" class="border p-1 w-full text-sm mb-2" placeholder="District Head Name">
                               <button onclick="saveDistAdmin('${selectedPath.district}')" class="text-xs bg-black text-white px-3 py-1 rounded">Assign</button>`;
        }
    });

    // वर्कर्स को कंट्रोल करें
    loadWorkersForAdmin();
}

// 4. वर्कर्स को हटाना (Rating और Mistake के आधार पर)
function loadWorkersForAdmin(){
    db.ref("workers").once("value", snap => {
        let html = "";
        snap.forEach(wSnap => {
            let w = wSnap.val();
            let pathKey = (selectedPath.state + "/" + selectedPath.district).replace(/\s/g, '');
            // चेक करें कि वर्कर इस जिले का है
            if(JSON.stringify(w.villages).includes(selectedPath.district)){
                html += `
                <div class="flex justify-between items-center border-b pb-2">
                    <div>
                        <p class="font-bold">${w.name}</p>
                        <p class="text-gray-400">${w.work}</p>
                    </div>
                    <button onclick="deleteWorker('${wSnap.key}')" class="btn-red">Ban Worker</button>
                </div>`;
            }
        });
        document.getElementById("workersList").innerHTML = html || "No workers found in this district.";
    });
}

/* Helper Functions */
function saveStateAdmin(st) { db.ref("stateAdmins/"+st).set({name: document.getElementById("stName").value}); }
function removeStateAdmin(st) { if(confirm("State Admin hata dein?")) db.ref("stateAdmins/"+st).remove(); }
function saveDistAdmin(ds) { db.ref("distAdmins/"+ds).set({name: document.getElementById("dsName").value}); }
function removeDistAdmin(ds) { if(confirm("District Admin hata dein?")) db.ref("distAdmins/"+ds).remove(); }
function deleteWorker(id) { if(confirm("Is worker ko app se permanent nikal dein?")) db.ref("workers/"+id).remove(); goToDistrict(); }

// शुरू में आम यूजर का स्टेट लोड करें
function loadUserApp() { 
    // यहाँ आपका पुराना यूजर वाला कोड लोड होगा
    loadStatePanel(); 
}

</script>
</body>
</html>
